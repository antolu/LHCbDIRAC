#!/usr/bin/env python
########################################################################
# $Header: /tmp/libdirac/tmp.stZoy15380/dirac/DIRAC3/scripts/Attic/dirac-update,v 1.10 2008/03/24 20:58:26 rgracian Exp $
# File :   dirac-update
# Author : Ricardo Graciani
########################################################################
__RCSID__   = "$Id: dirac-update,v 1.10 2008/03/24 20:58:26 rgracian Exp $"
__VERSION__ = "$Revision: 1.10 $"
"""
    Script to prepare/update a DIRAC instalation
"""

from dirac_functions import *

myFullName  = os.path.realpath( __file__ )
myShortName = os.path.basename( myFullName )

rootPath = logInit( myFullName )


tarFlag()

platform = get_platform( )

def parse_options():
  """
   parse command line options:
  """
  global platform
  help = """
   -b --build                  Force local compilation
   -d --debug                  Set debug flag
   -e --external=<version>     DIRAC-external <version> to install (overwrites -v)
   -h --help                   Print this
   -r --repository=<rep>       Use <rep> as cvs repository
   -p --platform=<platform>    Use <platform> instead of local one
   -u --url=<url>              Use <url> to download tarballs
   -v --version=<version>      DIRAC <version> to install
      --cvs                    Retrieve from CVS (implies -b)

  from DIRAC framework:

    -o --option=<Option=value> <Option=value> to add
    -s --section=<section>     Set base <section> for relative parsed options
    -c --cert=<cert>           Use server certificate <cert> to connect to Core Services

  """
  shortOptions = 'bde:hp:u:v:o:s:'
  longOptions  = ['build', 'debug', 'external=', 'help', 'platform=', 'url=', 'version=', 
                  'cvs', 
                  'option=', 'section=']
  try:
    ( optionVals, extraOptions ) = getopt.getopt( sys.argv[1:], shortOptions, longOptions )
  except getopt.GetoptError, x:
    logERROR( 'Parsing command line: %s' % x )
    optionVals = [ ('-h','') ]

  if ('-h','') in optionVals or ('--help','') in optionVals:
    logHelp( help )

  ext = None
  for o,v in optionVals:
    if o == '-b' or o == '--build':
      build()
    elif o == '-d' or o == '--debug':
      debug()
    elif o == '-e' or o == '--external':
      ext = v
    elif o == '-p' or o == '--platform':
      platform = set_platform(v)
    elif o == '-r' or o == '--repository':
      default_CVS(v)
    elif o == '-u' or o == '--url':
      default_URL( v )
    elif o == '-v' or o == '--version':
      version(v)
    elif o == '--cvs':
      cvsFlag()

    if ext: external(ext)


parse_options()
logINFO( 'Checking DIRAC instalation at "%s"' %  rootPath )
logINFO( 'Using platform "%s"' %  platform )

localPython   = os.path.join( rootPath, platform, 'bin', 'python' )
if not check_interpreter( localPython ):
  install_external( platform, defaultPython )
  localVersion = check_dirac( defaultVersion )
  # if we are not running with our onw python let's call ourself again
  logINFO( 'Will retry now with DIRAC python' )
  args         = str.join(' ',sys.argv[1:]) + ' -v %s' % localVersion
  logDEBUG( '%s %s %s ' % ( localPython, myFullName, args ) )
  ret = os.system( '%s %s %s ' % ( localPython, myFullName, args ) )
  sys.exit(ret)

else:
  localVersion = check_dirac( defaultVersion )
  from DIRACEnvironment import DIRAC
  if debugFlag:
    DIRAC.gLogger.setLevel( 'DEBUG' )
  else:
    DIRAC.gLogger.setLevel( 'INFO' )
  from DIRAC.Core.Utilities.GridCredentials import setDIRACGroup
  
  setDIRACGroup( 'lhcb_user' )
  
  from DIRAC.Core.Base import Script

  Script.registerSwitch( "b",  "build",     "Allow compilation if platform not available" )
  Script.registerSwitch( "d",  "debug",     "Set debug flag" )
  Script.registerSwitch( "e:", "external=", "DIRAC-external <version> to install" )
  Script.registerSwitch( "p:", "platform=", "Use <platform> instead of local one" )
  Script.registerSwitch( "u:", "url=",      "Use <url> to download tarballs" )
  Script.registerSwitch( "v:", "version=",  "DIRAC <version> to install" )
  
  from DIRAC.ConfigurationSystem.Client.LocalConfiguration import LocalConfiguration
  localCfg = LocalConfiguration()
  localCfg.addDefaultEntry( '/DIRAC/Setup', 'LHCb-Development' )
  localCfg.addDefaultEntry( '/DIRAC/Configuration/Servers',
                            'dips://lhcbprod.pic.es:9135/Configuration/Server, '
                            'dips://volhcb03.cern.ch:9135/Configuration/Server' )
  
  Script.parseCommandLine( scriptName = myShortName, ignoreErrors = True )
  
  DIRAC.gConfig.dumpLocalCFGToFile( cfgPath )
  # further checks can be implemented here
  logINFO( 'DIRAC version "%s" installed' % localVersion)
  logINFO( 'DIRAC-external version "%s" installed' % externalVersion)

  sys.exit(0)
