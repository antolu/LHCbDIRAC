#!/usr/bin/env python

import os
import sys
import getopt

# set SAME home directory assuming that executable is in SAME_HOME/bin
def setupHomeDir():
    global same_home
    if not os.environ.has_key('SAME_HOME'): 
	same_home=os.path.normpath(
	    os.path.dirname(os.path.abspath(sys.argv[0])) + "/..")
	os.environ['SAME_HOME']=same_home
    else:
	same_home=os.environ['SAME_HOME']
    sys.path.append(same_home+'/lib/python')
    os.environ['PATH']=same_home+'/bin:'+os.environ['PATH']

setupHomeDir()

def parseArgs():
    operations=['submit','publish','status','cancel','nodetest','unlock']
    opts,args=getopt.getopt(sys.argv[1:],'c:',operations)
    operation='submit'
    for o,v in opts:
        if o=='-c':
	    if v[0]!='/':
	        v=os.getcwd()+'/'+v
            Config.load(v)
            os.environ['SAME_CONFIG']=v
        else:
            operation=o.strip('-')
    sensor=args.pop(0)
    try:
        i=args.index('--')
        sargs=args[i+1:]
        args=args[:i]
    except:
        sargs=[]
        
    filter=' '.join(args)
    return operation,sensor,filter,sargs

def printUsage():
    sys.stderr.write("\nUsage:\n%s [-c <config_file>] [<operation>] <sensor_name> [<filter>]\n"%
		     sys.argv[0])
    sys.stderr.write("\nIf operation is not specified it defaults to '--submit'\n")
    sys.stderr.write("\nOperations:\n"+'\n'.join(map(lambda x: '--'+x,Sensor.operations))+'\n')
    sys.stderr.write("""\nFilter should be in the follwoing format:
attr1=val1,val2,... attr2=val3,... ...

""")
    
# MAIN

from same import Config

try:
    operation,sensor,user_filter,sensor_args=parseArgs()
except Exception,e:
    printUsage()
    sys.exit(1)

from same import Sensor
from same import Scheduler

print "operation: "+operation

if not Sensor.checkSensor(sensor):
    print "Sensor %s does not exist or is broken!"%sensor
    sys.exit(1)
        
if operation in Sensor.operations:
    try:
        Sensor.operationExec(operation,sensor,user_filter,sensor_args)
    except KeyboardInterrupt:
        print "Ctrl+C was pressed!"
        Sensor.unlockSensor(sensor)
        Scheduler.killall()
else:
    print "Operation not implemented!"



