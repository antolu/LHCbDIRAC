Instructions to make a release of LHCbDirac

Preparation of the LHCbDIRAC release
====================================
1 - you should edit the file svn+ssh://svn.cern.ch/reps/dirac/LHCbDIRAC/trunk/LHCbDIRAC/versions.cfg to create the proper tag vArBpC for LHCbDIRAC.
The format is :
  Next Release (from trunk)
  {
  }

  Next Release (from vArB)
  {
    #BUGFIX: fix the getProductions
    System1 = bk_2015062402
    #FIX (servers): copy all files parameters and run tables for derived productions
    System2 = ts_2015062403
  }

  vArBpC
  {
    System1 = ac_2015040101
    System2 = bk_2015062401
  }

2 - save and commit the versions.cfg file.

3 - you should edit the file svn+ssh://svn.cern.ch/reps/dirac/LHCbDIRAC/trunk/LHCbDIRAC/releases.cfg to create the proper tag vArBpC for LHCbDIRAC.
the format is :
Releases
{
  DEV
  {
    Modules = LHCbDIRAC:trunk, LHCbWebDIRAC:trunk
    Depends = DIRAC:v6r13-pre15
    LcgVer = 2015-02-27
  }

  vArBpC
  {
    Modules = LHCbDIRAC:vArBpC, LHCbWebDIRAC:vXrY
    Depends = DIRAC:vNrMpK
    LcgVer = 2015-06-23
  }


Modification of LHCbDirac project
=================================
1 - you should edit the file svn+ssh://svn.cern.ch/reps/dirac/LHCbDirac/trunk/LHCbDirac/cmt/project.cmt to create the proper tag vArBpC for LHCbDIRAC.
the format is :
project LHCbDirac
#use DIRAC DIRAC_v6r13p6
use DIRAC DIRAC_v6r14*
#use LHCBGRID LHCBGRID_v8r*
use LHCBGRID LHCBGRID_v9r*
use LCGCMT LCGCMT_76root6

build_strategy     with_installarea
setup_strategy     root
structure_strategy without_version_directory

container LHCbDiracSys



Creation of the tar ball for the LHCbDIRAC release
==================================================
4 - save and commit the releases.cfg file.
5 - login to lxplus
6 - if the new LHCbDIRAC is based on a new DIRAC version, please run "mkLHCbDirac_release.sh -D vNrMpK"
7 - if the new LHCbDIRAC is based on a new LHCbWebDIRAC version, please run "mkLHCbDirac_release.sh -W vXrY"
8 - now run "mkLHCbDirac_release.sh -L vArBpC -t"


Deployment on a single machine of the LHCbDIRAC release
========================================================
you are now ready to deploy the new LHCbDIRAC version on the VOBOXes
The basic way to deploy a new version on a single VOBOX is:
- SetupProject LHCbDirac
- lhcb-proxy-init -g lhcb_admin
- dirac-admin-sysadmin-cli -H MyVOBOX
and from the prompt :
[MyVOBOX] : update vArBpC
[MyVOBOX] : lhcb-restart-agent-service
[MyVOBOX] : quit

Deployment on all the VOBOX in production of the LHCbDIRAC release
==================================================================
go to a temporary directory and run the command
- create_vobox_update.py vArBpC
this command will create 6 files called "vobox_update_MyLetter"
then you can run in 6 windows the recipe for one single machine like that:
- SetupProject LHCbDirac
- lhcb-proxy-init -g lhcb_admin
- dirac-admin-sysadmin-cli
and from the prompt :
[host] : execfile vobox_update_MyLetter
[host] : quit

WARNING :
1 - check that all update went properly
2 - check that agents/services have restarted properly

Deployment on all the VOBOX in production of the LHCbDIRAC release by using the web portal
==================================================================
go to the SystemAdministrator page of the web portal, insert the version in the dedicated field and press Update.

Then eLOG the installation of the new LHCbDirac release

Update the Pilot version
========================
From  lxplus, once the tar ball has been created, you could update the pilot version with the following command:
- SetupProject LHCbDirac
- lhcb-proxy-init -g lhcb_admin
- dirac-pilot-version (will show the current version)
- dirac-pilot-version -S vArBpC (will update the version in the CS and in the JSON version use by VM)

Creation of the CLIENT release of LHCbDIRAC
===========================================
go to the web page : https://buildlhcb.cern.ch/jenkins/view/Nightly%20Builds%20Special/job/lhcb-release/build?delay=0sec
- in the field "Project list" put : "Dirac vNrMpK LHCbDirac vArBpC"
- in the field "platforms" put : "x86_64-slc6-gcc48-opt x86_64-slc6-gcc49-opt"
- in the field "os_label" put : "slc_urgent"
Then click on the "BUILD" button
- within 10-15 min the build should start to appear in the nightlies page https://buildlhcb.cern.ch/nightlies-release/
- if there is a problem in the build, it can be re-started via the dedicated button (it will not restart by itself after a retag)

If it is the production release, and only in this case, once satisfied by the build, take note of the build id (you can use the direct link icon) and make the request via https://sft.its.cern.ch/jira/browse/LHCBDEP

The LHCb Deployement shifter will deploy the release on AFS/CVMFS


Special case : Certification
============================
the certification machine is lbtestvobox.cern.ch
Once you will have deployed the "pre-release" of LHCbDirac on the machine using the section "Deployment on a single machine of the LHCbDIRAC release", you will get
an error "socket read timeout". DON'T PANIC.. it is "normal" as the timeout of the dirac-admin-syadmin-cli is too short to compile the web. So You
will have to login to the machine as dirac and compile the web portal using the command "dirac-webapp-compile"

To deploy the client part in LHCBDEV, you will have to do this :
- follow the instruction of "Creation of the CLIENT release of LHCbDIRAC" until the line "if it is the production..."
- note of the build id
- login to buildlhcb as you
- export build_id=The_Build_ID
- lb-release-rpm /data/artifacts/release/lhcb-release/$build_id  (check that all the info are correct)
if the previous action is OK,
- lb-release-rpm --copy /data/artifacts/release/lhcb-release/$build_id
- export MYSITEROOT='/afs/cern.ch/user/j/joel/work/certification/lhcb_rpm'
- ./lbpkr  rpm -- -ivh --nodeps /afs/cern.ch/lhcb/distribution/rpm/lhcb/DIRAC_vNrMpK*
- ./lbpkr  rpm -- -ivh --nodeps /afs/cern.ch/lhcb/distribution/rpm/lhcb/LHCBDIRAC_vArBpC*




